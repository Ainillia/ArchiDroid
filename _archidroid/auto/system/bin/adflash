#!/system/bin/sh

VERSION=""
TEMP=""
AD="/data/media/0/ArchiDroid"

echo "Welcome to ArchiDroid Command Line Flasher!"
echo "Checking access to $AD"
(mkdir -p $AD/tmp && touch $AD/test && rm -f $AD/test && echo "Test passed, we're ready to go!") || (echo "Sorry, access test failed. It looks like I need root" && exit 1)

if [ $# -eq 0 ]; then
	echo "Usage: $0 [VERSION]"
	echo ""
	echo "Available versions:"
	echo "2e	2.X-EXPERIMENTAL"
	echo "2s	2.X-STABLE"
	echo "1e	1.X-EXPERIMENTAL"
	echo "1s	1.X-STABLE"
	echo "local	If you have $AD/tmp/archidroid_github.zip downloaded already"
	echo ""
	echo -n "Your choice: "
	read VERSION
else
	VERSION="$1"
fi

case "$VERSION" in
	"2e")
		TEMP="2.X-EXPERIMENTAL"
		;;
	"2s")
		TEMP="2.X-STABLE"
		;;
	"1e")
		TEMP="1.X-EXPERIMENTAL"
		;;
	"1s")
		TEMP="1.X-STABLE"
		;;
	"local")
		TEMP="local"
		;;
	*)
		echo "Sorry, could not detect any valid version, exiting"
		exit 1
esac
VERSION=$TEMP
TEMP=""
echo "Ok, detected $VERSION"

(cd $AD/tmp && rm -rf _adflash && rm -f $AD/ArchiDroid.zip) || (echo "Unknown error, aborting" && exit 1)
cd $AD/tmp

if [ "$VERSION" != "local" ]; then
	curl -kSs https://raw.github.com/JustArchi/ArchiDroid/$VERSION/META-INF/com/google/android/aroma/_changelog.txt
	echo ""
	echo ""
	echo "Ok, starting download from GitHub"
	echo "Warning, it may take long time. Make sure that you have stable Wi-Fi connection"
	TEMP=`curl -kISs https://codeload.github.com/JustArchi/ArchiDroid/zip/$VERSION | grep "Content-Length" | awk '{print $2}'`
	TEMP=`expr $TEMP / 1000000`
	echo "It's about $TEMP Megabytes"
	TEMP=""
	echo "Downloading right now..."
	curl -Sk https://codeload.github.com/JustArchi/ArchiDroid/zip/$VERSION > archidroid_github.zip || (echo "Download failed, aborting" && exit 1)
	echo "Download completed, it took some time..."
fi

if [ ! -e archidroid_github.zip ]; then
	echo "Couldn't find $AD/tmp/archidroid_github.zip, aborting" && exit 1
fi

echo "Repacking downloaded ArchiDroid"
echo "Unzipping ArchiDroid in GitHub version"
mkdir _adflash
unzip -q archidroid_github.zip -d _adflash || (echo "Unzipping failed, aborting" && exit 1)
(cd _adflash && cd `ls`) || (echo "Moving to unzipped folder failed, aborting" && exit 1)
echo "Removing __dont_include folder..."
rm -rf __dont_include
echo "Zipping ArchiDroid to flashable version..."
zip -qry -1 ArchiDroid.zip . || (echo "Zipping failed, aborting" && exit 1)
mv ArchiDroid.zip $AD/ArchiDroid.zip
echo "Done, you can find your flashable rom in $AD/ArchiDroid.zip"
cd $AD/tmp
rm -rf *
echo "Happy Flashing!"
exit 0