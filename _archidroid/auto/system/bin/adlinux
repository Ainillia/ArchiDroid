#!/system/bin/sh

# ArchiDroid Debian/Linux Booter

if [ `whoami` != "root" ]; then
	echo "Sorry, but I require root access, trying to fork a rooted shell..."
	su || echo "Failed!"
	exit 0
fi

AD="/data/media/0/ArchiDroid"
mnt=$AD/debian

echo "Welcome to ArchiDroid Debian/Linux Booter!"
echo "Checking access to $AD"
mkdir -p $AD/tmp
cd $AD/tmp
touch test
CHECK1=$?
rm -f test
CHECK2=$?
if [ $CHECK1 -ne 0 ] || [ $CHECK2 -ne 0 ]; then
	echo "Sorry, access test failed. Make sure that $AD/tmp is not being owned by root or give me root access"
	exit 1
else
	echo "Access test passed, we're ready to go!"
fi

if [ $# -eq 0 ]; then
	echo "Usage: $0 <MODE>"
	echo ""
	echo "Available modes:"
	echo "unsafe	Will mount /data /system /storage/sdcard0 and /storage/sdcard1 in chroot. Default suggested mode"
	echo "safe	Won't mount above directories. In this mode chrooted debian won't be able to read/write to above android directories. Keep in mind that it'll still share /dev /proc and /sys with Android"
	echo "bare	Won't mount even required filesystems such as /proc /dev or /sys. In this mode debian won't be able to do nearly anything. Suggested only for testing purposes"
	echo "unmount	Will call force unmount/shutdown of previously mounted debian environment, required if you want to change mode of already booted debian."
	echo -n "Your choice: "
	read CHOICE
else
	CHOICE="$1"
fi

case "$CHOICE" in
	"unmount")
		busybox umount -f $mnt/storage/sdcard0 >/dev/null 2>&1
		busybox umount -f $mnt/storage/sdcard1 >/dev/null 2>&1
		busybox umount -f $mnt/system >/dev/null 2>&1
		busybox umount -f $mnt/data >/dev/null 2>&1
		busybox umount -f $mnt/sys >/dev/null 2>&1
		busybox umount -f $mnt/proc >/dev/null 2>&1
		busybox umount -f $mnt/dev/shm >/dev/null 2>&1
		busybox umount -f $mnt/dev/pts >/dev/null 2>&1
		busybox umount -f $mnt/dev >/dev/null 2>&1
		echo "Done, your debian environment is fully unmounted now"
		exit 0
		;;
	"unsafe")
		echo "Ok, detected $CHOICE"
		;;
	"safe")
		echo "Ok, detected $CHOICE"
		;;
	"bare")
		echo "Ok, detected $CHOICE"
		;;
	*)
		echo "Sorry, could not detect any valid choice, exiting"
		exit 1
esac

if [ -e $mnt/proc/uptime ]; then
	echo "It looks like your debian is already booted, skipping booting and mode selection..."
else
	echo "It looks like your debian isn't booted yet, booting..."

	if [ ! -e $mnt/bin/bash ]; then
		mkdir -p $mnt
		echo "It looks like it's your first installation. Unpacking your debian..."
		busybox tar -xf $AD/System/debian.tar.bz2 -C $mnt
		echo "Done!"
	fi

	echo "Booting debian..."

	case "$CHOICE" in
	"unsafe")
		echo "Mounting /dev /dev/pts /dev/shm /proc /sys /system /data /storage/sdcard0 /storage/sdcard1"
		busybox mount --bind /dev $mnt/dev
		busybox mount --bind /dev/pts $mnt/dev/pts
		mkdir -p $mnt/dev/shm
		busybox mount --bind /dev/shm $mnt/dev/shm
		busybox mount -t proc proc $mnt/proc
		busybox mount -t sysfs sysfs $mnt/sys
		busybox mount --bind /system $mnt/system
		busybox mount --bind /data $mnt/data
		busybox mount --bind /storage/sdcard0 $mnt/storage/sdcard0
		busybox mount --bind /storage/sdcard1 $mnt/storage/sdcard1
		;;
	"safe")
		echo "Mounting /dev /dev/pts /dev/shm /proc /sys, SKIPPING /system /data /storage/sdcard0 /storage/sdcard1"
		busybox mount --bind /dev $mnt/dev
		busybox mount --bind /dev/pts $mnt/dev/pts
		mkdir -p $mnt/dev/shm
		busybox mount --bind /dev/shm $mnt/dev/shm
		busybox mount -t proc proc $mnt/proc
		busybox mount -t sysfs sysfs $mnt/sys
		;;
	"bare")
		echo "Not mounting anything!"
		;;
	*)
		echo "Sorry, could not detect any valid choice, exiting"
		exit 1
	esac
fi

echo "ArchiDroid Debian environment ready!"
echo "Type debian to enter chroot"

exit 0